<html>

<head>
  <title>Tic Tac Toe </title>
  <style>
		.movementButton {
			width: 100%;
			height: 20vh;
			font-weight: bold;
			font-size: 18pt;
			font-color: blue;
		}

		td {
			width: 30%
		}

		.center {
			width: 80%;
			margin: 0 auto;
		}
		
		#nextPlayerBox {
			margin-left: 300px;
			font-weight: bold;
		}
	</style>
</head>

<body onload="newGame()">
	<div class="center">
		<h1 style="text-align: center">Tic Tac Toe Testing Front-end</h1>
		GameId: <span id="gameId"></span>,
		First Player: <span id="firstPlayer"></span>
		<span id="nextPlayerBox">Next Player: <span id="nextPlayer"></span><br />
		<br />
		<a href="/game/list" target="_blank">All games in memory</a><br/>
		<hr />
	</div>

	<table class="center">
		<tbody>
			<tr>
				<td><button class="movementButton" data-x="0", data-y="2" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="1", data-y="2" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="2", data-y="2" onclick="doMovement(this)"></button></td>
			</tr>
			<tr>
				<td><button class="movementButton" data-x="0", data-y="1" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="1", data-y="1" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="2", data-y="1" onclick="doMovement(this)"></button></td>
			</tr>
			<tr>
				<td><button class="movementButton" data-x="0", data-y="0" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="1", data-y="0" onclick="doMovement(this)"></button></td>
				<td><button class="movementButton" data-x="2", data-y="0" onclick="doMovement(this)"></button></td>			</tr>
		</tbody>
	</table>
	
	<br>
	<div class="center">
		Response: <span id="responseCode"></span>
		<pre id="responseData"></pre>
	</div>

	<script src="/jquery-3.4.1.min.js"></script>
	<script>
		$.ajaxSetup({
			contentType: "application/json; charset=utf-8"
		});
		
		$(function() {
			$(".movementButton").each(function() {
				$(this).html($(this).attr("data-x") + ', ' + $(this).attr("data-y"));
			});
		});

		function newGame() {
			$.post("/game", function(data) {
				window.game = data;
				window.currentPlayer = data.firstPlayer;

				$("#gameId").html(data.id);
				$("#firstPlayer").html(data.firstPlayer);
				
				if ( data.firstPlayer == 'X' ) {
					$("#nextPlayer").html('X');
					$("#nextPlayer").css('color', 'red');
				} else { 
					$("#nextPlayer").html('O');
					$("#nextPlayer").css('color', 'blue');
				}
			});
		}

		function doMovement(elm) {
			var x = $(elm).attr("data-x");
			var y = $(elm).attr("data-y");

			$(elm).html(currentPlayer);
			
			if ( window.currentPlayer == 'X' ) $(elm).css('color', 'red')
			else $(elm).css('color', 'blue');
			
			var postUrl = "/game/" + window.game.id + "/movement";
			
			var postData = JSON.stringify({
				"id" : window.game.id,
				"player": window.currentPlayer,
				"position": {
					"x": x,
					"y": y
				}
			});

			$.post(postUrl, postData, function(data, txtStatus, xhr) {				
				$("#responseCode").html(xhr.status + " - " + txtStatus);
				$("#responseData").html(JSON.stringify(data, null, 4));
				
				$("#nextPlayer").html(data.nextPlayer);
				if ( data.nextPlayer == 'X' ) {
					$("#nextPlayer").css('color', 'red');
				} else { 
					$("#nextPlayer").css('color', 'blue');
				}				
				
				if ( window.currentPlayer == 'X' ) window.currentPlayer = 'O'
				else window.currentPlayer = 'X';
			}).fail(function(xhr, txtStatus, error) {
				$("#responseCode").html(xhr.status + " - " + txtStatus);
				$("#responseData").html(JSON.stringify(xhr.responseJSON, null, 4) + xhr.responseText);				
				
				try {				
					if ( xhr.responseJSON.msg == 'Esta jogada já foi feita, contate o suporte do front-end' ) {						
						alert("Recebemos a informação do back-end que essa jogada já foi feita, iremos reiniciar o jogo");
						location.reload();
					}
				} catch(ex) {
					//nothing to do here
				}
			});
		}
	</script>

</body>
</html>
